#!/bin/bash
# git-library : Agentic Code Intelligence & Downloader
set -euo pipefail

# --- Environnement & PATH ---
export PATH="/usr/local/bin:/usr/bin:/bin:/mingw64/bin:/c/Windows/system32:/c/Windows:/c/Program Files/nodejs:/c/Python311:$PATH"

# --- Configuration & Constantes ---
VERSION="2.0.0"
CONFIG_DIR="$HOME/.gemini"
SKILLS_DIR="$CONFIG_DIR/skills"
LOG_FILE="$CONFIG_DIR/git-library.log"
BASE_DIR="/d/Git_fileordoc/git-library" # Chemin absolu dans l'environnement
VAULT_DIR="$BASE_DIR/vault"

# Initialisation
mkdir -p "$CONFIG_DIR/hooks" "$CONFIG_DIR/agents" "$VAULT_DIR"
touch "$LOG_FILE"

# Log logic
log() { echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"; }

# Sourcing components
# Note: On utilise des chemins relatifs à BASE_DIR ou absolus
source "$BASE_DIR/config/settings.env" 2>/dev/null || log "⚠️ settings.env non trouvé."
source "$BASE_DIR/src/policy/engine.sh"
source "$BASE_DIR/src/core/downloader.sh"
source "$BASE_DIR/src/agents/registry.sh"
source "$BASE_DIR/src/agents/academy.sh"
source "$BASE_DIR/src/surgical/surgeon.sh"
source "$BASE_DIR/src/wiki/generator.sh"
source "$BASE_DIR/src/hooks/generic_hook_runner.sh"

# Point d'Entrée
case "${1:-}" in
    "---help"|"-h")
        echo "Usage: git-library <URL_GITHUB> [NOM_SORTIE]"
        echo "       git-library chat <DOSSIER>     # Discuter avec le code"
        echo "       git-library test <FICHIER>     # Générer des tests"
        echo "       git-library deploy <DOSSIER>   # Déployer en staging"
        echo "       git-library ---version         # Afficher la version"
        exit 0
        ;;
    "---version")
        echo "git-library v$VERSION"
        exit 0
        ;;
    "chat")
        shift
        if [ -f "$BASE_DIR/src/agents/chat.sh" ]; then
            source "$BASE_DIR/src/agents/chat.sh"
            chat_with_code "$@"
        else
            echo "❌ Erreur : Module Chat non installé."
        fi
        ;;
    "test")
        shift
        if [ -f "$BASE_DIR/src/agents/test_gen.sh" ]; then
            source "$BASE_DIR/src/agents/test_gen.sh"
            generate_unit_test "$@"
        else
            echo "❌ Erreur : Module Test Gen non installé."
        fi
        ;;
    "deploy")
        shift
        if [ -f "$BASE_DIR/src/agents/deploy.sh" ]; then
            source "$BASE_DIR/src/agents/deploy.sh"
            deploy_to_staging "$@"
        else
            echo "❌ Erreur : Module Deploy non installé."
        fi
        ;;
    "surgery")
        if [ $# -lt 2 ]; then echo "Usage: git-library surgery <path>"; exit 1; fi
        run_surgery "$2"
        generate_wiki_entry "$2" "directory"
        ;;
    "teach")
        if [ $# -lt 2 ]; then echo "Usage: git-library teach <path>"; exit 1; fi
        # Détection du python fonctionnel (évite les shims Windows vides)
        PYTHON_BIN=""
        if python3 --version &> /dev/null; then
            PYTHON_BIN="python3"
        elif py -3 --version &> /dev/null; then
            PYTHON_BIN="py -3"
        elif python --version &> /dev/null; then
            PYTHON_BIN="python"
        else
            echo "❌ Erreur : Python (ou py launcher) requis pour le mode Academy."
            exit 1
        fi
        
        $PYTHON_BIN "$BASE_DIR/src/agents/academy.py" "$2" "$VAULT_DIR" "${GEMINI_API_KEY}"
        ;;
    *)
        # Par défaut, on télécharge
        fetch_content "$@"
        ;;
esac
